<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Certificate Portal (Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 450px; text-align: center; margin-top: 30px;}
        h2 { color: #333; margin-bottom: 20px; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background 0.3s; font-weight: bold; }
        
        .btn-connect { background-color: #2ecc71; color: white; width: 200px; margin-bottom: 10px;}
        .btn-verify { background-color: #4a90e2; color: white; }
        .btn-issue { background-color: #e67e22; color: white; }
        .btn-download { background-color: #f1c40f; color: white; display: none; margin-top: 15px; border: 2px solid #f39c12; color: #d35400;}
        .btn-download:hover { background-color: #f39c12; color: white; }

        #status { margin-top: 20px; font-size: 14px; color: #666; word-break: break-word; min-height: 20px;}
    </style>
</head>
<body>

    <button id="connectBtn" class="btn-connect" onclick="connectWallet()">Connect Wallet</button>

    <div class="container">
        <h2>üéì Certificate Verifier</h2>
        <p style="color:#777; font-size: 14px;">Blockchain Powered System</p>

        <input type="text" id="studentID" placeholder="Student ID (e.g., 101)">
        <input type="text" id="course" placeholder="Course Name (e.g., BSc Computer Science)">
        
        <button class="btn-verify" onclick="checkCertificate()">Verify Certificate</button>
        <button class="btn-issue" onclick="issueCertificate()">Issue Certificate (Admin Only)</button>
        
        <button id="downloadBtn" class="btn-download" onclick="downloadPDF()">‚¨áÔ∏è Download Official Certificate</button>

        <div id="status">Status: Not Connected</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const contractAddress = "0x1F1597503F1cdA31D503Be33f01D6112297449D2"; // Your deployed contract
        const abi = [
            "function issueCertificate(bytes32 _hash) public",
            "function verifyCertificate(bytes32 _hash) public view returns (bool)"
        ];

        let provider, signer, contract;

        async function connectWallet() {
            if (window.ethereum) {
                try {
                    await window.ethereum.request({ method: "eth_requestAccounts" });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(contractAddress, abi, signer);
                    
                    const address = await signer.getAddress();
                    document.getElementById("status").innerText = "Connected: " + address.substring(0, 6) + "...";
                    document.getElementById("connectBtn").innerText = "Wallet Connected";
                    document.getElementById("connectBtn").style.backgroundColor = "#27ae60";
                } catch (err) { alert("Connection denied."); }
            } else { alert("Please install MetaMask!"); }
        }

        async function issueCertificate() {
            if (!contract) return alert("Please Connect Wallet first!");
            const id = document.getElementById("studentID").value;
            const course = document.getElementById("course").value;
            const hash = ethers.utils.solidityKeccak256(["string", "string"], [id, course]);

            try {
                document.getElementById("status").innerText = "Issuing... Please confirm in MetaMask.";
                const tx = await contract.issueCertificate(hash);
                document.getElementById("status").innerText = "Transaction Sent! Waiting for confirmation...";
                await tx.wait();
                document.getElementById("status").innerText = "‚úÖ Success! Certificate Issued on Blockchain.";
            } catch (err) {
                console.error(err);
                document.getElementById("status").innerText = "Error: " + (err.reason || "Transaction failed");
            }
        }

        async function checkCertificate() {
            if (!contract) return alert("Please Connect Wallet first!");
            const id = document.getElementById("studentID").value;
            const course = document.getElementById("course").value;
            const hash = ethers.utils.solidityKeccak256(["string", "string"], [id, course]);

            try {
                const isValid = await contract.verifyCertificate(hash);
                if (isValid) {
                    document.getElementById("status").style.color = "green";
                    document.getElementById("status").innerHTML = "<b>‚úÖ VERIFIED:</b> This certificate is authentic.";
                    document.getElementById("downloadBtn").style.display = "block"; // SHOW THE BUTTON
                } else {
                    document.getElementById("status").style.color = "red";
                    document.getElementById("status").innerText = "‚ùå FAKE: No record found on blockchain.";
                    document.getElementById("downloadBtn").style.display = "none";
                }
            } catch (err) { console.error(err); }
        }

        // --- PDF GENERATION LOGIC ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "landscape" });

            const id = document.getElementById("studentID").value;
            const course = document.getElementById("course").value;

            // Decorative Border
            doc.setLineWidth(3);
            doc.setDrawColor(44, 62, 80); 
            doc.rect(10, 10, 277, 190); 

            // Title
            doc.setFont("helvetica", "bold");
            doc.setFontSize(40);
            doc.setTextColor(44, 62, 80);
            doc.text("Certificate of Completion", 148.5, 50, null, null, "center");

            // Subtitle
            doc.setFont("helvetica", "normal");
            doc.setFontSize(20);
            doc.setTextColor(100);
            doc.text("This is to certify that", 148.5, 80, null, null, "center");

            // Student ID
            doc.setFontSize(30);
            doc.setTextColor(41, 128, 185); // Blue
            doc.text(`Student ID: ${id}`, 148.5, 100, null, null, "center");

            // Course Text
            doc.setFontSize(20);
            doc.setTextColor(100);
            doc.text("Has successfully completed the course:", 148.5, 130, null, null, "center");

            // Course Name
            doc.setFontSize(25);
            doc.setTextColor(0);
            doc.text(course, 148.5, 150, null, null, "center");

            // Footer
            doc.setFontSize(12);
            doc.setTextColor(150);
            doc.text(`Verified on Ethereum Blockchain | Contract: ${contractAddress.substring(0,10)}...`, 148.5, 185, null, null, "center");

            doc.save(`Certificate_${id}.pdf`);
        }
    </script>
</body>
</html>